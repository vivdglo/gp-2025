<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; }

    .stage { position: fixed; inset: 0; overflow: hidden; }

    video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 1;
    }
/* --- POOR AI PANEL (same style as rich) --- */
.poor-ai {
  position: fixed;
  right: 2rem;
  bottom: 2rem;
  width: min(520px, 86vw);
  z-index: 6;
  pointer-events: none;

  opacity: 0;
  transform: translateY(10px);
  transition: opacity 1.6s ease, transform 1.6s ease;
}

.poor-ai.visible {
  opacity: 0.88;
  transform: translateY(0);
}

.panel {
  background: rgba(0, 0, 0, 0.42);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 1.2rem;
  padding: 1.2rem 1.2rem;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  overflow: hidden;
}

.panel-title {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  font-size: 0.95rem;
  font-weight: 700;
  letter-spacing: 0.09em;
  text-transform: uppercase;
  opacity: 0.9;
  margin-bottom: 0.9rem;
}

.agent-content {
  display: grid;
  grid-template-columns: 42% 1fr;
  gap: 1rem;
  align-items: start;
}

.hud-agent {
  width: 100%;
  height: auto;
  max-height: 220px;
  object-fit: contain;
  opacity: 0.95;
  justify-self: end;
}

.agent-message {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  font-size: 0.98rem;
  line-height: 1.5;
  color: rgba(255,255,255,0.92);
}

.agent-name {
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  font-size: 0.8rem;
  opacity: 0.9;
  margin-bottom: 0.4rem;
}

.agent-message p {
  margin: 0 0 0.75rem 0;
}

.agent-muted {
  opacity: 0.75;
}

    #faceBox {
      position: absolute;
      border: 3px solid red;
      background: transparent;
      box-sizing: border-box;
      left: -9999px;
      top: -9999px;
      width: 120px;
      height: 120px;
      z-index: 3;
      pointer-events: none;
    }

    /* Label that follows the face box */
    #patientTag {
  position: absolute;
  left: -9999px;
  top: -9999px;
  z-index: 4;
  pointer-events: none;

  display: inline-flex;
  align-items: center;
  gap: 0.6rem;

  padding: 0.45rem 0.75rem;
  border-radius: 999px;
  border: 2px solid red;
  background: rgba(0,0,0,0.6);
  color: white;

  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

.tag-text {
  display: flex;
  flex-direction: column;
  line-height: 1.1;
}

.tag-title {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.tag-sub {
  font-size: 10px;
  opacity: 0.75;
  letter-spacing: 0.06em;
}

.tag-icon {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: red;
}


    /* Simple icon */
    .tag-icon {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: red;
      display: inline-block;
    }

    .back-btn { position: fixed; top: 1.5rem; left: 1.5rem; z-index: 10; }

    #status {
      position: fixed;
      left: 1.5rem;
      bottom: 1.5rem;
      z-index: 10;
      color: #fff;
      background: rgba(0,0,0,0.55);
      padding: 0.6rem 0.8rem;
      border-radius: 0.8rem;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 92vw;
    }
  </style>
</head>

<body>
  <button class="back-btn" onclick="location.href='index.html'">Back</button>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <div id="faceBox"></div>

    <div id="patientTag">
        <span class="tag-icon"></span>
        <div class="tag-text">
          <div class="tag-title">Regular patient</div>
          <div class="tag-sub">Access tier: BASIC</div>
        </div>
      </div>
      <div id="poorAI" class="poor-ai">
        <div class="panel">
          <div class="panel-title">AI agent</div>
      
          <div class="agent-content">
            <img src="assets/AIassistant for rich.png" class="hud-agent" alt="AI Agent">
      
            <div class="agent-message">
              <div class="agent-name">Basic triage</div>
              <p>
                Your account is on the BASIC tier. Real-time diagnostics and predictive analysis are not available.
              </p>
              <p class="agent-muted">
                Please visit your local hospital and wait in the public queue for assessment.
              </p>
            </div>
          </div>
        </div>
      </div>
      
  <div id="status">Diagnosing...</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>

  <script>
    const poorAI = document.getElementById("poorAI");
let aiShown = false;

    const videoEl = document.getElementById("video");
    const stageEl = document.getElementById("stage");
    const faceBox = document.getElementById("faceBox");
    const patientTag = document.getElementById("patientTag");
    const statusEl = document.getElementById("status");

    function hideOverlays() {
      faceBox.style.left = "-9999px";
      faceBox.style.top = "-9999px";
      patientTag.style.left = "-9999px";
      patientTag.style.top = "-9999px";
    }

    function placeSquareAndTagFromSourceBBox(srcX, srcY, srcW, srcH) {
      const rect = stageEl.getBoundingClientRect();
      const screenW = rect.width;
      const screenH = rect.height;

      const vidW = videoEl.videoWidth;
      const vidH = videoEl.videoHeight;
      if (!vidW || !vidH) return;

      const scale = Math.max(screenW / vidW, screenH / vidH);
      const dispW = vidW * scale;
      const dispH = vidH * scale;

      const offsetX = (screenW - dispW) / 2;
      const offsetY = (screenH - dispH) / 2;

      let x = offsetX + srcX * scale;
      let y = offsetY + srcY * scale;
      let w = srcW * scale;
      let h = srcH * scale;

      // mirror correction
      x = screenW - x - w;

      // square
      const s = Math.max(w, h);
      const cx = x + w / 2;
      const cy = y + h / 2;

      const left = cx - s / 2;
      const top = cy - s / 2;

      faceBox.style.left = `${left}px`;
      faceBox.style.top = `${top}px`;
      faceBox.style.width = `${s}px`;
      faceBox.style.height = `${s}px`;

      // tag above-left of the square
      patientTag.style.left = `${Math.max(12, left)}px`;
      patientTag.style.top = `${Math.max(12, top - 34)}px`;
    }

    async function startCamera() {
      statusEl.textContent = "Requesting cameraâ€¦";
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      videoEl.srcObject = stream;

      await new Promise((resolve) => {
        if (videoEl.readyState >= 2) resolve();
        else videoEl.onloadedmetadata = () => resolve();
      });

      try { await videoEl.play(); } catch {}
    }

    async function start() {
      try {
        await startCamera();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Camera permission denied/unavailable.";
        return;
      }

      statusEl.textContent = "Identifying the patient...";
      let model;
      try {
        model = await blazeface.load();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Model failed to load (check internet/CDN).";
        return;
      }

      statusEl.textContent = "Basic patient";

      async function loop() {
        try {
          const faces = await model.estimateFaces(videoEl, false);

          if (faces && faces.length > 0) {
            statusEl.textContent = "Face detected";
            const f = faces[0];
            const tl = f.topLeft;
            const br = f.bottomRight;

            const x = tl[0];
            const y = tl[1];
            const w = br[0] - tl[0];
            const h = br[1] - tl[1];

            placeSquareAndTagFromSourceBBox(x, y, w, h);
            if (!aiShown) {
                poorAI.classList.add("visible");
                aiShown = true;
}

          } else {
            statusEl.textContent = "No face";
            hideOverlays();
            poorAI.classList.remove("visible");
            aiShown = false;

          }
        } catch (e) {
          console.error(e);
          statusEl.textContent = "Detection error (see Console).";
          hideOverlays();
          return;
        }

        requestAnimationFrame(loop);
      }

      loop();
    }

    start();
  </script>
</body>
</html>
